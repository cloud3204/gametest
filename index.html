<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>控制視窗</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  label, select, input, button { margin: 5px; }
</style>
</head>
<body>
<h1>控制面板</h1>

<!-- 腐敗輸入 -->
<h3>腐敗警察</h3>
<label>腐敗警察1:
  <select id="badteam1">
    <option value="紅">紅</option>
    <option value="藍">藍</option>
    <option value="黃">黃</option>
  </select>
</label>
<label>編號: <input type="number" id="BADplayer1Num" min="1" max="4" value="1"></label>
<button id="sendBADPlayer1">確認</button><br>

<label>腐敗警察2:
  <select id="badteam2">
    <option value="紅">紅</option>
    <option value="藍">藍</option>
    <option value="黃">黃</option>
  </select>
</label>
<label>編號: <input type="number" id="BADplayer2Num" min="1" max="4" value="1"></label>
<button id="sendBADPlayer2">確認</button>

<!-- 回合 -->
<h2>
  回合: <span id="roundDisplay">0</span>
  <button id="prevRound">上一回合</button>
  <button id="nextRound">下一回合</button>
</h2>

<h2>計時器</h2>
<div>
  <span id="countdownDisplay" style="font-size: 24px; font-weight: bold;">00:00</span><br>
  <button id="start3min">倒數 3 分鐘</button>
  <button id="start5min">倒數 5 分鐘</button>
  <button id="pauseTimer">暫停時間</button>
</div>

<!-- 玩家輸入 -->
<h3>玩家標記</h3>
<label>隊伍:
  <select id="team">
    <option value="紅">紅</option>
    <option value="藍">藍</option>
    <option value="黃">黃</option>
  </select>
</label>
<label>編號: <input type="number" id="playerNum" min="1" max="4" value="1"></label>
<label>位置: <input type="number" id="pos" min="1" max="176" value="1"></label>
<button id="sendPlayer">新增玩家標記</button>

<!-- 小偷足跡輸入 -->
<h3>小偷足跡</h3>
<label>小偷編號:
  <select id="thiefId">
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
</label>
<label>位置: <input type="number" id="thiefPos" min="1" max="176" value="1"></label>
<button id="sendThief">新增小偷足跡</button>

<!-- 調查與抓捕 -->
<h3>調查與抓捕</h3>
<button id="investigate">調查</button>
<button id="capture">抓捕</button>

<h3>操作紀錄</h3>
<div id="actionLog"
     style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; font-family: monospace; font-size: 14px;">
</div>

<script>
  let mapWindow = null;
  let currentRound = 0;
  const roundData = {};
  const coordinates_list = [
   {x: 796, y: 158},
{x: 737, y: 158},
{x: 678, y: 158},
{x: 616, y: 158},
{x: 524, y: 159},
{x: 502, y: 206},
{x: 481, y: 253},
{x: 459, y: 301},
{x: 439, y: 345},
{x: 395, y: 442},
{x: 376, y: 484},
{x: 335, y: 528},
{x: 294, y: 528},
{x: 253, y: 528},
{x: 191, y: 528},
{x: 138, y: 468},
{x: 85, y: 468},
{x: 32, y: 468},
{x: 70, y: 535},
{x: 508, y: 300},
{x: 562, y: 301},
{x: 616, y: 301},
{x: 678, y: 300},
{x: 730, y: 345},
{x: 771, y: 346},
{x: 808, y: 345},
{x: 849, y: 345},
{x: 889, y: 345},
{x: 925, y: 345},
{x: 961, y: 345},
{x: 961, y: 401},
{x: 962, y: 455},
{x: 961, y: 507},
{x: 961, y: 557},
{x: 961, y: 626},
{x: 961, y: 693},
{x: 895, y: 693},
{x: 853, y: 693},
{x: 812, y: 693},
{x: 736, y: 693},
{x: 627, y: 726},
{x: 567, y: 726},
{x: 507, y: 726},
{x: 443, y: 726},
{x: 383, y: 726},
{x: 325, y: 726},
{x: 268, y: 726},
{x: 211, y: 726},
{x: 176, y: 696},
{x: 138, y: 662},
{x: 138, y: 596},
{x: 138, y: 534},
{x: 138, y: 409},
{x: 138, y: 354},
{x: 138, y: 296},
{x: 193, y: 256},
{x: 252, y: 216},
{x: 297, y: 216},
{x: 340, y: 216},
{x: 381, y: 216},
{x: 400, y: 300},
{x: 559, y: 345},
{x: 589, y: 401},
{x: 606, y: 435},
{x: 623, y: 470},
{x: 643, y: 508},
{x: 663, y: 546},
{x: 679, y: 581},
{x: 697, y: 616},
{x: 716, y: 655},
{x: 757, y: 733},
{x: 775, y: 770},
{x: 849, y: 769},
{x: 928, y: 769},
{x: 971, y: 769},
{x: 1012, y: 770},
{x: 1053, y: 769},
{x: 1094, y: 769},
{x: 1120, y: 734},
{x: 1149, y: 696},
{x: 616, y: 207},
{x: 616, y: 252},
{x: 516, y: 345},
{x: 476, y: 346},
{x: 453, y: 401},
{x: 464, y: 444},
{x: 472, y: 485},
{x: 484, y: 529},
{x: 505, y: 616},
{x: 479, y: 662},
{x: 461, y: 694},
{x: 1064, y: 256},
{x: 1009, y: 256},
{x: 956, y: 256},
{x: 901, y: 256},
{x: 850, y: 256},
{x: 799, y: 256},
{x: 673, y: 346},
{x: 616, y: 345},
{x: 543, y: 253},
{x: 460, y: 206},
{x: 421, y: 206},
{x: 369, y: 350},
{x: 338, y: 401},
{x: 299, y: 460},
{x: 214, y: 450},
{x: 177, y: 374},
{x: 175, y: 60},
{x: 196, y: 101},
{x: 214, y: 138},
{x: 231, y: 175},
{x: 275, y: 264},
{x: 296, y: 308},
{x: 315, y: 352},
{x: 384, y: 401},
{x: 500, y: 401},
{x: 542, y: 401},
{x: 678, y: 252},
{x: 678, y: 207},
{x: 878, y: 296},
{x: 826, y: 385},
{x: 807, y: 421},
{x: 785, y: 460},
{x: 761, y: 503},
{x: 737, y: 545},
{x: 717, y: 580},
{x: 647, y: 662},
{x: 595, y: 662},
{x: 543, y: 662},
{x: 424, y: 662},
{x: 367, y: 662},
{x: 311, y: 662},
{x: 254, y: 662},
{x: 197, y: 662},
{x: 104, y: 598},
{x: 1029, y: 305},
{x: 997, y: 351},
{x: 1045, y: 455},
{x: 1068, y: 507},
{x: 1093, y: 558},
{x: 1114, y: 607},
{x: 1130, y: 650},
{x: 230, y: 325},
{x: 263, y: 391},
{x: 317, y: 494},
{x: 378, y: 616},
{x: 440, y: 616},
{x: 570, y: 616},
{x: 632, y: 616},
{x: 735, y: 616},
{x: 774, y: 616},
{x: 801, y: 587},
{x: 829, y: 557},
{x: 874, y: 557},
{x: 916, y: 557},
{x: 1006, y: 558},
{x: 1049, y: 557},
{x: 694, y: 388},
{x: 660, y: 427},
{x: 570, y: 528},
{x: 529, y: 528},
{x: 438, y: 528},
{x: 395, y: 528},
{x: 357, y: 442},
{x: 773, y: 222},
{x: 753, y: 282},
{x: 749, y: 385},
{x: 765, y: 421},
{x: 806, y: 509},
{x: 852, y: 603},
{x: 872, y: 647},
{x: 911, y: 731},
{x: 259, y: 130},
{x: 338, y: 310},
{x: 793, y: 655},
{x: 832, y: 731},
  ];
  let playerData = [];
  let bad1Data=[];
  let bad2Data=[];
  let thiefData = { 1: [], 2: [] };

  function openMapWindow() {
    mapWindow = window.open("map.html", "mapWindow", "width=1200,height=900");
  }
  openMapWindow();

  function sendMessage(message) {
    if (mapWindow) {
      mapWindow.postMessage(message, "*");
    }
  }

  //紀錄
  function logAction(text) {
  const logDiv = document.getElementById("actionLog");
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement("div");
   entry.textContent = `[${time}] 第 ${currentRound} 回合：${text}`;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight; //自動捲到底
  }

  // 呼叫地圖清除
  function clearMarkers() {
  sendMessage({ type: "clearMarkers" })};
  // 根據 round 重畫標記
  function renderRound(round) {
  const data = roundData[round];
    if (!data) return;
    data.players.forEach(p => {
      sendMessage({
        type: "addPlayer",
        team: p.team,
        playerNum: p.playerNum,
        position: p.position
      });
    });
  }
  //回合
  document.getElementById("roundDisplay").textContent = currentRound;
  // 控制回合按鈕
  document.getElementById("nextRound").onclick = () => {
    currentRound++;
    document.getElementById("roundDisplay").textContent = currentRound;
    sendMessage({ type: "updateRound", round: currentRound });
    clearMarkers(); // 清地圖上的玩家標記
    renderRound(currentRound);
  };

  document.getElementById("prevRound").onclick = () => {
    if (currentRound > 0) {
      currentRound--;
      document.getElementById("roundDisplay").textContent = currentRound;
      sendMessage({ type: "updateRound", round: currentRound });
      clearMarkers();
      renderRound(currentRound);
    }
  };

  //腐警
  document.getElementById("sendBADPlayer1").onclick = () => {
    const team = document.getElementById("badteam1").value;
    const BADPlayerId = document.getElementById("BADplayer1Num").value;
    bad1Data = [{ team, BADPlayer1Id: BADPlayerId }];
    alert("腐敗警察1 設定完成");
    console.log("bad1Data", bad1Data); // 除錯用
  };
  

 document.getElementById("sendBADPlayer2").onclick = () => {
    const team = document.getElementById("badteam2").value;
    const BADPlayerId = document.getElementById("BADplayer2Num").value;
    bad2Data = [{ team, BADPlayer1Id: BADPlayerId }];
    alert("腐敗警察2 設定完成");
    console.log("bad2Data", bad2Data); // 除錯用
  };

  //警察
  document.getElementById("sendPlayer").onclick = () => {
    const round = currentRound;
    const team = document.getElementById("team").value;
    const playerNum = document.getElementById("playerNum").value;
    const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;
    
    logAction(`${team}${playerNum} 移動至 ${posIndex + 1} 號位置`);
    //判斷陣列座標有效位
    if (posIndex < 0 || posIndex >= coordinates_list.length) {
      alert("位置超出範圍");
      return;
    }

    const position = coordinates_list[posIndex];
    playerData.push({ round, team, playerNum, position });
    const player = { team, playerNum, position };

    if (!roundData[round]) roundData[round] = { players: [] };
    roundData[round].players.push({ team, playerNum, position }); 

    sendMessage({ type: "addPlayer", ...player });;
  };

  //小偷
  document.getElementById("sendThief").onclick = () => {
    const round = document.getElementById("roundDisplay").value;
    const thiefId = document.getElementById("thiefId").value;
    const posIndex = parseInt(document.getElementById("thiefPos").value, 10) - 1;

    logAction(`小偷${thiefId} 移動至 ${posIndex + 1} 號位置`);
    if (posIndex < 0 || posIndex >= coordinates_list.length) {
      alert("位置超出範圍");
      return;
    }

    const position = coordinates_list[posIndex];
    thiefData[thiefId].push(position);

    sendMessage({type: "addThief",thiefId,position});
  };

  //調查
  document.getElementById("investigate").onclick = () => {
  const team = document.getElementById("team").value;
  const playerNum = document.getElementById("playerNum").value;
  const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;

  logAction(`${team}${playerNum} 在 ${posIndex + 1} 號位置執行調查`);
  if (posIndex < 0 || posIndex >= coordinates_list.length) {
    alert("位置超出範圍");
    return;
  }

  const position = coordinates_list[posIndex];

  sendMessage({ 
    type: "investigate", 
    player: { team, playerNum, position }, 
    thiefData 
  });
};

//抓捕
document.getElementById("capture").onclick = () => {
  const team = document.getElementById("team").value;
  const playerNum = document.getElementById("playerNum").value;
  const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;

  logAction(`${team}${playerNum} 在 ${posIndex + 1} 號位置執行抓捕`);
  if (posIndex < 0 || posIndex >= coordinates_list.length) {
    alert("位置超出範圍");
    return;
  }

  const position = coordinates_list[posIndex];

  sendMessage({ 
    type: "capture", 
    player: { team, playerNum, position }, 
    thiefData,
    bad1Data,
    bad2Data
  });
};

//倒數
let countdownTimer = null;
let remainingSeconds = 0;
let isPaused = false;

const countdownDisplay = document.getElementById("countdownDisplay");

function updateDisplay() {
  const minutes = Math.floor(remainingSeconds / 60);
  const seconds = remainingSeconds % 60;
  countdownDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  sendMessage({ type: "updateTimer", time: countdownDisplay.textContent });
}

function startCountdown(seconds) {
  // 先清除原本的倒數
  if (countdownTimer) clearInterval(countdownTimer);
  remainingSeconds = seconds;
  isPaused = false;
  updateDisplay();

  countdownTimer = setInterval(() => {
    if (!isPaused) {
      remainingSeconds--;
      updateDisplay();

      if (remainingSeconds <= 0) {
        clearInterval(countdownTimer);
        countdownDisplay.textContent = "時間到！";
        alert("倒數結束！");
      }
    }
  }, 1000);
}

document.getElementById("start3min").onclick = () => startCountdown(3 * 60);
document.getElementById("start5min").onclick = () => startCountdown(5 * 60);
document.getElementById("pauseTimer").onclick = () => {
  isPaused = !isPaused;
  document.getElementById("pauseTimer").textContent = isPaused ? "繼續時間" : "暫停時間";
};

//回傳抓捕資訊
window.addEventListener("message", (event) => {
  const data = event.data;
  if (data.type === "logCaptureResult") {
    const { team, playerNum } = data.player;
    logAction(`${team}${playerNum} ${data.result}`);
  }
});

</script>
</body>
</html>

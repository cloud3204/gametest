<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ§åˆ¶é¢æ¿</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2, h3 {
      margin-top: 30px;
      text-align: center;
    }

    button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    select, input {
      margin: 5px;
      padding: 6px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .section {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 600px;
      text-align: center;
    }

    #countdownDisplay, #roundDisplay {
      font-size: 28px;
      font-weight: bold;
      margin: 10px 0;
    }

    .log-box {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background: #f9f9f9;
      font-family: monospace;
      font-size: 14px;
      border-radius: 6px;
      text-align: left;
    }

    .title-bar {
      background-color: #343a40;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 24px;
      text-align: center;
      width: 600px;
    }
  </style>
</head>
<body>

<div class="title-bar">éŠæˆ²æ§åˆ¶é¢æ¿</div>
<button onclick="clearPoliceLog()" style="margin-left: 10px;">æ¸…ç©ºç´€éŒ„ éŠæˆ²çµæŸåœ¨æŒ‰!</button>
<button onclick="resetToken()">ğŸ” é‡æ–°è¼¸å…¥ Token</button>
<div class="section">
  
  <h3>è…æ•—è­¦å¯Ÿè¨­å®š</h3>
  è…æ•—è­¦1ï¼š<select id="badteam1">
    <option value="ç´…">ç´…</option>
    <option value="è—">è—</option>
    <option value="é»ƒ">é»ƒ</option>
  </select>
  ç·¨è™Ÿï¼š<select id="BADplayer1Num">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
  </select>
  <button id="sendBADPlayer1">è¨­å®š</button>
  <br>
  è…æ•—è­¦2ï¼š<select id="badteam2">
    <option value="ç´…">ç´…</option>
    <option value="è—">è—</option>
    <option value="é»ƒ">é»ƒ</option>
  </select>
  ç·¨è™Ÿï¼š<select id="BADplayer2Num">
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
  </select>
  <button id="sendBADPlayer2">è¨­å®š</button>
</div>

<div class="section">
  <h3>å›åˆèˆ‡è¨ˆæ™‚</h3>
  <div>
    å›åˆï¼š<span id="roundDisplay">0</span><br>
    <button id="prevRound">ä¸Šä¸€å›åˆ</button>
    <button id="nextRound">ä¸‹ä¸€å›åˆ</button>
  </div>
  <div style="margin-top: 20px;">
    <div id="countdownDisplay">00:00</div>
    <button id="start3min">å€’æ•¸ 3 åˆ†é˜</button>
    <button id="start5min">å€’æ•¸ 5 åˆ†é˜</button>
    <button id="pauseTimer">æš«åœæ™‚é–“</button>
  </div>
</div>

<div class="section">
  <h3>å°å·è¶³è·¡(é è¨­éš±è—)</h3>
  å°å·ï¼š<select id="thiefId">
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
  ä½ç½®ï¼š<input type="text" id="thiefPos" size="5">
  <button id="sendThief">ç§»å‹•</button>
  <br>
  <button id="showThief">é¡¯ç¤ºå°å·è¶³è·¡</button>
  <button id="hideThief">éš±è—å°å·è¶³è·¡</button>
</div>

<div class="section">
  <h3>ç©å®¶ç§»å‹•</h3>
  <div>
    éšŠä¼ï¼š<select id="team">
      <option value="ç´…">ç´…</option>
      <option value="è—">è—</option>
      <option value="é»ƒ">é»ƒ</option>
    </select>
    ç·¨è™Ÿï¼š<select id="playerNum">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
    ä½ç½®ï¼š<input type="text" id="pos" size="5">
    <button id="sendPlayer">ç§»å‹•</button>
  </div>
</div>

<div class="section">
  <h3>èª¿æŸ¥èˆ‡æŠ“æ•</h3>
  <button id="investigate">èª¿æŸ¥</button>
  <button id="capture">æŠ“æ•</button>
  <div id="investigationResult" style="margin-top: 10px; font-weight: bold; background: #eef; padding: 10px; border-radius: 6px;">ï¼ˆå°šæœªé€²è¡Œèª¿æŸ¥ï¼‰</div>
</div>

<div class="section">
  <h3>è­¦å¯Ÿæ“ä½œç´€éŒ„</h3>
  <div id="actionLog" class="log-box"></div>
</div>

<div class="section">
  <h3>å°å·è¶³è·¡ç´€éŒ„</h3>
  <div id="thiefLog" class="log-box" style="background:#fff3f3;"></div>
</div>

</body>
</html>


<script>
  let mapWindow = null;
  let currentRound = 0;
  const roundData = {};
  const coordinates_list = [
   {x: 796, y: 158},
{x: 737, y: 158},
{x: 678, y: 158},
{x: 616, y: 158},
{x: 524, y: 159},
{x: 502, y: 206},
{x: 481, y: 253},
{x: 459, y: 301},
{x: 439, y: 345},
{x: 395, y: 442},
{x: 376, y: 484},
{x: 335, y: 528},
{x: 294, y: 528},
{x: 253, y: 528},
{x: 191, y: 528},
{x: 138, y: 468},
{x: 85, y: 468},
{x: 32, y: 468},
{x: 70, y: 535},
{x: 508, y: 300},
{x: 562, y: 301},
{x: 616, y: 301},
{x: 678, y: 300},
{x: 730, y: 345},
{x: 771, y: 346},
{x: 808, y: 345},
{x: 849, y: 345},
{x: 889, y: 345},
{x: 925, y: 345},
{x: 961, y: 345},
{x: 961, y: 401},
{x: 962, y: 455},
{x: 961, y: 507},
{x: 961, y: 557},
{x: 961, y: 626},
{x: 961, y: 693},
{x: 895, y: 693},
{x: 853, y: 693},
{x: 812, y: 693},
{x: 736, y: 693},
{x: 627, y: 726},
{x: 567, y: 726},
{x: 507, y: 726},
{x: 443, y: 726},
{x: 383, y: 726},
{x: 325, y: 726},
{x: 268, y: 726},
{x: 211, y: 726},
{x: 176, y: 696},
{x: 138, y: 662},
{x: 138, y: 596},
{x: 138, y: 534},
{x: 138, y: 409},
{x: 138, y: 354},
{x: 138, y: 296},
{x: 193, y: 256},
{x: 252, y: 216},
{x: 297, y: 216},
{x: 340, y: 216},
{x: 381, y: 216},
{x: 400, y: 300},
{x: 559, y: 345},
{x: 589, y: 401},
{x: 606, y: 435},
{x: 623, y: 470},
{x: 643, y: 508},
{x: 663, y: 546},
{x: 679, y: 581},
{x: 697, y: 616},
{x: 716, y: 655},
{x: 757, y: 733},
{x: 775, y: 770},
{x: 849, y: 769},
{x: 928, y: 769},
{x: 971, y: 769},
{x: 1012, y: 770},
{x: 1053, y: 769},
{x: 1094, y: 769},
{x: 1120, y: 734},
{x: 1149, y: 696},
{x: 616, y: 207},
{x: 616, y: 252},
{x: 516, y: 345},
{x: 476, y: 346},
{x: 453, y: 401},
{x: 464, y: 444},
{x: 472, y: 485},
{x: 484, y: 529},
{x: 505, y: 616},
{x: 479, y: 662},
{x: 461, y: 694},
{x: 1064, y: 256},
{x: 1009, y: 256},
{x: 956, y: 256},
{x: 901, y: 256},
{x: 850, y: 256},
{x: 799, y: 256},
{x: 673, y: 346},
{x: 616, y: 345},
{x: 543, y: 253},
{x: 460, y: 206},
{x: 421, y: 206},
{x: 369, y: 350},
{x: 338, y: 401},
{x: 299, y: 460},
{x: 214, y: 450},
{x: 177, y: 374},
{x: 175, y: 60},
{x: 196, y: 101},
{x: 214, y: 138},
{x: 231, y: 175},
{x: 275, y: 264},
{x: 296, y: 308},
{x: 315, y: 352},
{x: 384, y: 401},
{x: 500, y: 401},
{x: 542, y: 401},
{x: 678, y: 252},
{x: 678, y: 207},
{x: 878, y: 296},
{x: 826, y: 385},
{x: 807, y: 421},
{x: 785, y: 460},
{x: 761, y: 503},
{x: 737, y: 545},
{x: 717, y: 580},
{x: 647, y: 662},
{x: 595, y: 662},
{x: 543, y: 662},
{x: 424, y: 662},
{x: 367, y: 662},
{x: 311, y: 662},
{x: 254, y: 662},
{x: 197, y: 662},
{x: 104, y: 598},
{x: 1029, y: 305},
{x: 997, y: 351},
{x: 1045, y: 455},
{x: 1068, y: 507},
{x: 1093, y: 558},
{x: 1114, y: 607},
{x: 1130, y: 650},
{x: 230, y: 325},
{x: 263, y: 391},
{x: 317, y: 494},
{x: 378, y: 616},
{x: 440, y: 616},
{x: 570, y: 616},
{x: 632, y: 616},
{x: 735, y: 616},
{x: 774, y: 616},
{x: 801, y: 587},
{x: 829, y: 557},
{x: 874, y: 557},
{x: 916, y: 557},
{x: 1006, y: 558},
{x: 1049, y: 557},
{x: 694, y: 388},
{x: 660, y: 427},
{x: 570, y: 528},
{x: 529, y: 528},
{x: 438, y: 528},
{x: 395, y: 528},
{x: 357, y: 442},
{x: 773, y: 222},
{x: 753, y: 282},
{x: 749, y: 385},
{x: 765, y: 421},
{x: 806, y: 509},
{x: 852, y: 603},
{x: 872, y: 647},
{x: 911, y: 731},
{x: 259, y: 130},
{x: 338, y: 310},
{x: 793, y: 655},
{x: 832, y: 731},
  ];
  let playerData = [];
  let bad1Data=[];
  let bad2Data=[];
  let thiefData = { 1: [], 2: [] };
  let policeLog = [];

  function openMapWindow() {
    mapWindow = window.open("map.html", "mapWindow", "width=1200,height=900");
  }
  openMapWindow();

  function sendMessage(message) {
    if (mapWindow) {
      mapWindow.postMessage(message, "*");
    }
  }

  document.getElementById("showThief").onclick = () => {
  sendMessage({ type: "toggleThief", show: true });
};
  document.getElementById("hideThief").onclick = () => {
  sendMessage({ type: "toggleThief", show: false });
};
  
  //ç´€éŒ„è­¦
  function logAction(text) {
  const logDiv = document.getElementById("actionLog");
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement("div");
  entry.textContent = `[${time}] ç¬¬ ${currentRound} å›åˆï¼š${text}`;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight; //è‡ªå‹•æ²åˆ°åº•
  policeLog.push(entry);// è¨˜éŒ„åˆ°å…¨åŸŸè®Šæ•¸
  uploadLogToGitHub({ police: policeLog });//ä¸Šå‚³åˆ° GitHub
  }
  //ç´€éŒ„å·
  function logThiefAction(text) {
  const logDiv = document.getElementById("thiefLog");
  const time = new Date().toLocaleTimeString();
  const entry = document.createElement("div");
  entry.textContent = `[${time}] ç¬¬ ${currentRound} å›åˆï¼š${text}`;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight; // è‡ªå‹•æ²åˆ°åº•
}

  // å‘¼å«åœ°åœ–æ¸…é™¤
  function clearMarkers() {
  sendMessage({ type: "clearMarkers" })};
  // æ ¹æ“š round é‡ç•«æ¨™è¨˜
  function renderRound(round) {
  const data = roundData[round];
    if (!data) return;
    data.players.forEach(p => {
      sendMessage({
        type: "addPlayer",
        team: p.team,
        playerNum: p.playerNum,
        position: p.position
      });
    });
  }
  //å›åˆ
  document.getElementById("roundDisplay").textContent = currentRound;
  // æ§åˆ¶å›åˆæŒ‰éˆ•
  document.getElementById("nextRound").onclick = () => {
    currentRound++;
    document.getElementById("roundDisplay").textContent = currentRound;
    sendMessage({ type: "updateRound", round: currentRound });
    clearMarkers(); // æ¸…åœ°åœ–ä¸Šçš„ç©å®¶æ¨™è¨˜
    renderRound(currentRound);
  };

  document.getElementById("prevRound").onclick = () => {
    if (currentRound > 0) {
      currentRound--;
      document.getElementById("roundDisplay").textContent = currentRound;
      sendMessage({ type: "updateRound", round: currentRound });
      clearMarkers();
      renderRound(currentRound);
    }
  };

  //è…è­¦
  document.getElementById("sendBADPlayer1").onclick = () => {
    const team = document.getElementById("badteam1").value;
    const BADPlayerId = document.getElementById("BADplayer1Num").value;
    bad1Data = [{ team, BADPlayer1Id: BADPlayerId }];
    alert("è…æ•—è­¦å¯Ÿ1 è¨­å®šå®Œæˆ");
    console.log("bad1Data", bad1Data); // é™¤éŒ¯ç”¨
  };
  

 document.getElementById("sendBADPlayer2").onclick = () => {
    const team = document.getElementById("badteam2").value;
    const BADPlayerId = document.getElementById("BADplayer2Num").value;
    bad2Data = [{ team, BADPlayer1Id: BADPlayerId }];
    alert("è…æ•—è­¦å¯Ÿ2 è¨­å®šå®Œæˆ");
    console.log("bad2Data", bad2Data); // é™¤éŒ¯ç”¨
  };

  //è­¦å¯Ÿ
  document.getElementById("sendPlayer").onclick = () => {
    const round = currentRound;
    const team = document.getElementById("team").value;
    const playerNum = document.getElementById("playerNum").value;
    const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;
    
    logAction(`${team}${playerNum} ç§»å‹•è‡³ ${posIndex + 1} è™Ÿä½ç½®`);
    //åˆ¤æ–·é™£åˆ—åº§æ¨™æœ‰æ•ˆä½
    if (posIndex < 0 || posIndex >= coordinates_list.length) {
      alert("ä½ç½®è¶…å‡ºç¯„åœ");
      return;
    }

    const position = coordinates_list[posIndex];
    playerData.push({ round, team, playerNum, position });
    const player = { team, playerNum, position };

    if (!roundData[round]) roundData[round] = { players: [] };
    roundData[round].players.push({ team, playerNum, position }); 

    sendMessage({ type: "addPlayer", ...player });;
  };

  //å°å·
  document.getElementById("sendThief").onclick = () => {
    const round = document.getElementById("roundDisplay").value;
    const thiefId = document.getElementById("thiefId").value;
    const posIndex = parseInt(document.getElementById("thiefPos").value, 10) - 1;

    logThiefAction(`å°å·${thiefId} ç§»å‹•è‡³ ${posIndex + 1} è™Ÿä½ç½®`);
    if (posIndex < 0 || posIndex >= coordinates_list.length) {
      alert("ä½ç½®è¶…å‡ºç¯„åœ");
      return;
    }

    const position = coordinates_list[posIndex];
    thiefData[thiefId].push(position);

    sendMessage({type: "addThief",thiefId,position});

  };

  //èª¿æŸ¥
  document.getElementById("investigate").onclick = () => {
  const team = document.getElementById("team").value;
  const playerNum = document.getElementById("playerNum").value;
  const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;

  logAction(`${team}${playerNum} åœ¨ ${posIndex + 1} è™Ÿä½ç½®åŸ·è¡Œèª¿æŸ¥`);
  if (posIndex < 0 || posIndex >= coordinates_list.length) {
    alert("ä½ç½®è¶…å‡ºç¯„åœ");
    return;
  }

  const position = coordinates_list[posIndex];

  sendMessage({ 
    type: "investigate", 
    player: { team, playerNum, position }, 
    thiefData 
  });
};

//æŠ“æ•
document.getElementById("capture").onclick = () => {
  const team = document.getElementById("team").value;
  const playerNum = document.getElementById("playerNum").value;
  const posIndex = parseInt(document.getElementById("pos").value, 10) - 1;

  logAction(`${team}${playerNum} åœ¨ ${posIndex + 1} è™Ÿä½ç½®åŸ·è¡ŒæŠ“æ•`);
  if (posIndex < 0 || posIndex >= coordinates_list.length) {
    alert("ä½ç½®è¶…å‡ºç¯„åœ");
    return;
  }

  const position = coordinates_list[posIndex];

  sendMessage({ 
    type: "capture", 
    player: { team, playerNum, position }, 
    thiefData,
    bad1Data,
    bad2Data
  });
};

//å€’æ•¸
let countdownTimer = null;
let remainingSeconds = 0;
let isPaused = false;

const countdownDisplay = document.getElementById("countdownDisplay");

function updateDisplay() {
  const minutes = Math.floor(remainingSeconds / 60);
  const seconds = remainingSeconds % 60;
  countdownDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  sendMessage({ type: "updateTimer", time: countdownDisplay.textContent });
}

function startCountdown(seconds) {
  // å…ˆæ¸…é™¤åŸæœ¬çš„å€’æ•¸
  if (countdownTimer) clearInterval(countdownTimer);
  remainingSeconds = seconds;
  isPaused = false;
  updateDisplay();

  countdownTimer = setInterval(() => {
    if (!isPaused) {
      remainingSeconds--;
      updateDisplay();

      if (remainingSeconds <= 0) {
        clearInterval(countdownTimer);
        countdownDisplay.textContent = "æ™‚é–“åˆ°ï¼";
        alert("å€’æ•¸çµæŸï¼");
      }
    }
  }, 1000);
}

document.getElementById("start3min").onclick = () => startCountdown(3 * 60);
document.getElementById("start5min").onclick = () => startCountdown(5 * 60);
document.getElementById("pauseTimer").onclick = () => {
  isPaused = !isPaused;
  document.getElementById("pauseTimer").textContent = isPaused ? "ç¹¼çºŒæ™‚é–“" : "æš«åœæ™‚é–“";
};

//å›å‚³æŠ“æ•èª¿æŸ¥è³‡è¨Š
window.addEventListener("message", (event) => {
  const data = event.data;
  if (data.type === "logInvestigationResult") {
  const { team, playerNum } = data.player;
  const resultText = `${team}${playerNum} èª¿æŸ¥çµæœï¼š${data.result}`;
  document.getElementById("investigationResult").textContent = resultText;
}
  if (data.type === "logCaptureResult") {
    const { team, playerNum } = data.player;
    logAction(`${team}${playerNum} ${data.result}`);
  }
});
 
//ä¸Šå‚³log
async function uploadLogToGitHub(logData) {
  const repo = "gametest";
  const owner = "cloud3204";
  const filename = "log.json";
  let token = localStorage.getItem("github_token");
  if (!token) {
    token = prompt("è«‹è¼¸å…¥ GitHub Tokenï¼ˆåªæœƒå•ä¸€æ¬¡ï¼‰ï¼š");
    if (!token) {
      alert("âŒ æ²’æœ‰æä¾› tokenï¼Œç„¡æ³•ä¸Šå‚³ç´€éŒ„");
      return;
    }
    localStorage.setItem("github_token", token);
  }

  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filename}`;

  // å–å¾—ç¾æœ‰ SHAï¼ˆå¦‚æª”æ¡ˆå·²å­˜åœ¨ï¼‰
  let sha = null;
  try {
    const res = await fetch(apiUrl, {
      headers: {  Authorization: `Bearer ${token}` }
    });
    if (res.ok) {
      const json = await res.json();
      sha = json.sha;
    }
  } catch (e) {
    console.warn("ç„¡æ³•å–å¾— log.json SHAï¼Œå¯èƒ½æ˜¯é¦–æ¬¡å»ºç«‹ã€‚");
  }

  // å°‡ JSON è½‰æˆ base64
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(logData, null, 2))));

  // å¯«å…¥ï¼æ›´æ–°æª”æ¡ˆ
  const res = await fetch(apiUrl, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Auto update police log",
      content: content,
      sha: sha
    })
  });

  if (!res.ok) {
  const errorText = await res.text();
  console.error("âŒ ä¸Šå‚³å¤±æ•—ï¼š", errorText);
  alert("âŒ ä¸Šå‚³å¤±æ•—ï¼Œä¼ºæœå™¨å›æ‡‰ï¼š" + errorText);
}
}

//æ¸…é™¤ç´€éŒ„
function clearPoliceLog() {
  const password = prompt("âš ï¸è¦åˆªé™¤è«‹è¼¸å…¥ç¢ºå®šä¸è¦å°±ç©ºç™½");
  const correctPassword = "ç¢ºå®š";
  if (password !== correctPassword) {
    alert("ç´€éŒ„æœªæ¸…ç©ºï¼");
    return;
  }
  policeLog = [];
  // 2. æ¸…é™¤ç•«é¢ä¸Šçš„ log å€åŸŸ
  const logDiv = document.getElementById("actionLog");
  if (logDiv) logDiv.textContent = "";
  uploadLogToGitHub({ police: [] });
  alert("âœ… è­¦å¯Ÿç´€éŒ„å·²æ¸…ç©ºï¼");
}

function resetToken() {
  localStorage.removeItem("github_token");
  alert("å·²æ¸…é™¤ Tokenï¼Œä¸‹æ¬¡æ“ä½œæ™‚æœƒè¦æ±‚é‡æ–°è¼¸å…¥ï¼");
}

</script>
</body>
</html>
